<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.7371b6fbed938cdba466.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}small{font-size:80%}h1,p{margin:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}h1{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-gray-100{--bg-opacity:1;background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity))}.bg-gray-300{--bg-opacity:1;background-color:#e2e8f0;background-color:rgba(226,232,240,var(--bg-opacity))}.hover\:bg-gray-400:hover{--bg-opacity:1;background-color:#cbd5e0;background-color:rgba(203,213,224,var(--bg-opacity))}.rounded{border-radius:.25rem}.flex{display:flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-between{justify-content:space-between}.font-bold{font-weight:700}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-3xl{font-size:1.875rem}.text-5xl{font-size:3rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mr-3{margin-right:.75rem}.p-6{padding:1.5rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pt-2{padding-top:.5rem}.pb-3{padding-bottom:.75rem}.pb-5{padding-bottom:1.25rem}.pl-5{padding-left:1.25rem}.pt-6{padding-top:1.5rem}.pb-6{padding-bottom:1.5rem}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.hover\:shadow-md:hover{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.text-left{text-align:left}.text-gray-800{--text-opacity:1;color:#2d3748;color:rgba(45,55,72,var(--text-opacity))}.text-pink-600{--text-opacity:1;color:#d53f8c;color:rgba(213,63,140,var(--text-opacity))}.hover\:text-gray-700:hover{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}.uppercase{text-transform:uppercase}.capitalize{text-transform:capitalize}.no-underline{text-decoration:none}.hover\:underline:hover{text-decoration:underline}.w-1\/2{width:50%}.w-full{width:100%}.nunito{font-family:Nunito,sans-serif}p{margin-bottom:.75rem}a{--text-opacity:1;color:#ed64a6;color:rgba(237,100,166,var(--text-opacity));text-decoration:underline}</style><meta name="generator" content="Gatsby 2.18.17"/><link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet"/><link as="script" rel="preload" href="/webpack-runtime-b4f9663c8c66499d7c8d.js"/><link as="script" rel="preload" href="/app-75c380aa823ade8e7cd6.js"/><link as="script" rel="preload" href="/styles-89302ffc91d24a21370e.js"/><link as="script" rel="preload" href="/commons-5705c9267cfc5d8183ec.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-6867365149186f8c8c2f.js"/><link as="fetch" rel="preload" href="/page-data\2015-10-09-soft-cascading\page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="bg-gray-100 nunito"><div class="container mx-auto flex flex-wrap py-6"><header class="pl-5 pb-6"><a class="font-bold text-gray-800 uppercase hover:text-gray-700 text-5xl no-underline" href="/">Unlikenesses <span class="text-xl">A PHP Developer</span></a><nav><a class="no-underline mr-3 text-gray-800" href="https://twitter.com/unlikenesses" target="_blank" rel="noopener noreferrer">Twitter</a><a class="no-underline mr-3 text-gray-800" href="https://github.com/unlikenesses" target="_blank" rel="noopener noreferrer">GitHub</a><a class="no-underline text-gray-800" href="http://codepen.io/unlikenesses/" target="_blank" rel="noopener noreferrer">CodePen</a></nav></header><section class="w-full flex flex-col items-center px-3"><article class="w-full flex flex-col shadow my-4"><div class="bg-white flex flex-col justify-start p-6"><h1 class="text-3xl font-bold hover:text-gray-700 capitalize">soft cascading</h1><span class="text-sm pb-3">09 October, 2015</span><div><p>So despite my adventures in Laravel (which continue whenever I have some spare time), the difficulties deploying it to crappy shared hosting are making me stick to CodeIgniter for any real-life, paid work projects. I've recently been porting (well, completely rewriting) my CMS for CodeIgniter 3, and have decided to implement cascading deletes. All very easy with MySQL:</p>
<p>Imagine I have two tables, <code>employers</code> and <code>employees</code>. <code>employees</code> is a child table of <code>employers</code>, and has a field that contains the parent row's <code>id</code>. Set this as index. Then set as foreign key related to the employer <code>id</code>. Then specify <code>on delete cascade</code>.</p>
<p>This works fine. But what if I want to implement soft-deletes? I am using Jamie Rumbelow's <a href="https://github.com/jamierumbelow/codeigniter-base-model">base model</a>. It's very easy to set up soft deletes. In <code>MY_Model</code>, set</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token keyword">protected</span> <span class="token variable">$soft_delete</span> <span class="token operator">=</span> <span class="token boolean constant">TRUE</span><span class="token punctuation">;</span></code></pre></div>
<p>and</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token keyword">protected</span> <span class="token variable">$soft_delete_key</span></code></pre></div>
<p>to the <code>deleted</code> field (must be <code>INT</code> or <code>TINYINT</code>) in your table.</p>
<p>Now I create an employer, add an employee. Delete the employer, and magically its <code>deleted</code> flag is set to <code>1</code>. I can restore the employer by resetting the flag to zero.</p>
<p>The problem we now have is that we want to soft-delete any children of this employer too: a kind of cascade for the <code>deleted</code> flag. Luckily <code>MY_Model</code> provides callback functions for <code>create</code>, <code>update</code>, <code>get</code> and <code>delete</code>. I should be able to create a function which is called after the <code>delete</code> method, which will go through all the children of a parent row and set their <code>deleted</code> flag to <code>1</code>.</p>
<p>So in my <code>Admin</code> model (which extends <code>MY_Model</code>) I add <code>public $before_delete = array('cascade_soft_delete');</code>, and create a function <code>cascade_soft_delete</code>. But then how do I know what the child table is of any given parent table? Or even if the table in which the row has been deleted IS a parent table? </p>
<p>Enter relationships, also provided for by Rumbelow's <code>MY_Model</code>. I can say that one table 'belongs to' another, and that another table 'has many' of another. So in this case, <code>employees</code> 'belongs to' <code>employers</code>, and <code>employers</code> 'has many' <code>employees</code>. But here I hit a problem. According to the repo's <a href="https://github.com/jamierumbelow/codeigniter-base-model/blob/master/README.md">readme</a>, 'It will assume that a <code>MY_Model</code> API-compatible model with the singular relationship's name has been defined'. But I am not using models for each table. Instead, I have a single, <code>Admin</code> model which takes care of CRUD commands for all my tables. If I want to change the <code>$table</code> variable, I call a <code>set_table</code> method in the <code>Admin</code> model, called from the controller for a particular table. Actually, it turns out that this works anyway.</p>
<p>So if I go ahead and create a similar function called <code>set_belongs_to</code> in my <code>Admin</code> model, then call it in my <code>Employees</code> controller, like so:</p>
<p>Admin model:</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_belongs_to</span><span class="token punctuation">(</span><span class="token variable">$table</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">belongs_to</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Employees controller:</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Admin_model</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">set_belongs_to</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'employers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>I can then finally write the <code>cascade_soft_delete</code> method. It's very simple:</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">cascade_soft_delete</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">has_many</span> <span class="token keyword">as</span> <span class="token variable">$child</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">set_table</span><span class="token punctuation">(</span><span class="token variable">$child</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">update_by</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'parent'</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deleted'</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">set_table</span><span class="token punctuation">(</span><span class="token variable">$table</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$row</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>First it grabs the current table so it can restore it at the end. Then, it loops through the <code>has_many</code> array (which in my example only contains <code>employees</code>) to grab the children. For each child, it sets it as the current working table, then updates it, setting <code>deleted</code> to be <code>1</code> where the <code>parent</code> foreign key field is equal to the <code>$row</code> variable (i.e. the <code>id</code> of the row about to be deleted from the parent table). At the end it resets the working table to the parent table. And hey presto: cascading soft deletes!</p></div></div></article><div class="w-full flex pt-6"><a class="w-1/2 bg-white shadow hover:shadow-md text-left p-6 no-underline" href="/2015-09-06-literally-literals/"><p class="text-lg text-gray-800 font-bold flex items-center">Previous<!-- -->:</p><p class="pt-2 capitalize">Object Literals<!-- --> <small>06 September, 2015</small></p></a><a class="w-1/2 bg-white shadow hover:shadow-md text-left p-6 no-underline" href="/2015-10-22-tanking/"><p class="text-lg text-gray-800 font-bold flex items-center">Next<!-- -->:</p><p class="pt-2 capitalize">Tank Auth in CodeIgniter 3<!-- --> <small>22 October, 2015</small></p></a></div></section></div><footer class="container mx-auto flex flex-wrap py-4 pl-5"><p>Â© <!-- -->2020<!-- --> Unlikenesses</p></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2015-10-09-soft-cascading/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-75c380aa823ade8e7cd6.js"],"component---src-templates-index-js":["/component---src-templates-index-js-ae34d3afc8e89f50bee5.js"],"component---src-templates-post-js":["/component---src-templates-post-js-6867365149186f8c8c2f.js"],"component---src-pages-404-js":["/component---src-pages-404-js-224a4a61ab9775ba900d.js"]};/*]]>*/</script><script src="/component---src-templates-post-js-6867365149186f8c8c2f.js" async=""></script><script src="/commons-5705c9267cfc5d8183ec.js" async=""></script><script src="/styles-89302ffc91d24a21370e.js" async=""></script><script src="/app-75c380aa823ade8e7cd6.js" async=""></script><script src="/webpack-runtime-b4f9663c8c66499d7c8d.js" async=""></script></body></html>