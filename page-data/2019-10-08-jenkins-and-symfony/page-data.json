{"componentChunkName":"component---src-templates-post-js","path":"/2019-10-08-jenkins-and-symfony/","result":{"data":{"post":{"html":"<p>These are my notes on the process of setting up a CI environment on Jenkins for Symfony projects. It's pretty generic, though, so most if not all of it will apply to Laravel or other PHP frameworks too. Note this is not about CD (deployment): that might come in a later post.</p>\n<h2>The Jenkins Server</h2>\n<p>First, we need a server running Jenkins. I'm going to use a Digital Ocean $5 droplet for this, with Ubuntu 18.04.3.</p>\n<h3>Setting up the Digital Ocean droplet</h3>\n<p>First, follow <a href=\"https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04\">this tutorial</a> to set up a new sudo user, configure and enable the firewall, and make sure you have SSH access to the server with the new user.</p>\n<p>Then install Java following the instructions in <a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-on-ubuntu-18-04#installing-specific-versions-of-openjdk\">this tutorial</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> upgrade\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> default-jre <span class=\"token comment\"># Install Java Runtime Environment</span></code></pre></div>\n<h3>Installing Jenkins</h3>\n<p>Following <a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-jenkins-on-ubuntu-18-04\">this tutorial</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> -q -O - https://pkg.jenkins.io/debian/jenkins.io.key <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> apt-key <span class=\"token function\">add</span> -\n<span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> jenkins</code></pre></div>\n<h3>Starting Jenkins</h3>\n<p>Still following the DO tutorial. Start the Jenkins service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl start jenkins\n<span class=\"token function\">sudo</span> systemctl status jenkins</code></pre></div>\n<p>Allow it access through the firewall:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> ufw allow <span class=\"token number\">8080</span>\n<span class=\"token function\">sudo</span> ufw status</code></pre></div>\n<p>Now you should be able to visit it in your browser, with your droplet's IP address followed by <code>:8080</code>. Get the password from your server:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">cat</span> /var/lib/jenkins/secrets/initialAdminPassword</code></pre></div>\n<p>and copy it into the form on the browser. I'm now going to install the suggested plugins, create a user, then accept the Jenkins URL and click \"Start Using Jenkins\".</p>\n<h3>Testing it works</h3>\n<p>Let's just test it works. Click \"New Item\", select \"Freestyle Project\" and give it a name like \"test\", then click OK. On the configuration page, scroll down to the bottom, click \"Add build step\", then select \"Execute shell\" from the dropdown list. In the \"Command\" text area that appears, enter <code>echo 'hello'</code>, then click \"Save\". You'll be taken back to the project's overview page. Click \"Build Now\" in the left-hand menu. After a few seconds a new entry should appear in the Build History. Click it, then click \"Console Output\": you should see your echoed string there.</p>\n<h2>Jenkins and PHP</h2>\n<p>I'll start with a single action to keep things simple at first. I want to pull the latest code from its repo, run its tests in PHPUnit, and log the results. Create a new Freestyle Project, give it a name, then enter the Git repo URL under \"Source Code Management\". Click \"Save\". If you now click on \"Build Now\" and let the build run, then click the build and \"Console Output\", you'll see that Jenkins clones the repo into its server. Now if you SSH into your server, and go to the Jenkins <code>jobs</code> directory: </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /var/lib/jenkins/jobs</code></pre></div>\n<p>You'll see a directory named after the project you just created. <code>cd</code> into it, then <code>cat config.xml</code>. This is your job's template. You'll see an <code>scm</code> tag which contains your git repo's URL. </p>\n<h3>Installing PHP</h3>\n<p>Back in the Jenkins panel, we want to add a build step that will run PHPUnit. So click \"Add build step\", then select \"Execute shell\", then... what? Well we want to run PHPUnit, but we haven't installed it yet. We know PHPUnit is a dependency of Symfony, so we would need to run a <code>composer install</code> after cloning the repo. So we can SSH into the server and install Composer, right? But wait! We still haven't even installed PHP on the server yet. So let's do that. SSH into the server, then run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> php </code></pre></div>\n<p>This will install the PHP <a href=\"https://help.ubuntu.com/community/MetaPackages\">metapackage</a>, which includes a number of useful packages as well as the most up to date PHP interpreter for your operating system. Now to check it's installed, enter <code>php -v</code> (the <code>-v</code> flag requests the version). You should see something like this:</p>\n<blockquote>\n<p>PHP 7.2.19-0ubuntu0.18.04.2 (cli) (built: Aug 12 2019 19:34:28) ( NTS )\nCopyright (c) 1997-2018 The PHP Group\nZend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies\nwith Zend OPcache v7.2.19-0ubuntu0.18.04.2, Copyright (c) 1999-2018, by Zend Technologies</p>\n</blockquote>\n<p>We also want to install some packages required by Symfony and PHPUnit:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> php-xml php-zip php-curl php-mbstring php-xdebug</code></pre></div>\n<h3>Installing Composer</h3>\n<p>Now to install Composer, go to <a href=\"https://getcomposer.org/download/\">Composer's download page</a>, copy the first line of the script there, and paste it in your terminal:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php -r <span class=\"token string\">\"copy('https://getcomposer.org/installer', 'composer-setup.php');\"</span></code></pre></div>\n<p>Then we want to install it globally: </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> php composer-setup.php --install-dir<span class=\"token operator\">=</span>/usr/local/bin --filename<span class=\"token operator\">=</span>composer</code></pre></div>\n<p>Now if you type <code>composer</code> and hit enter you should see its help page.</p>\n<h3>Add Composer build step</h3>\n<p>Go back to the Jenkins front-end, and configure the project. Add a build step, of the \"Execute shell\" type, then enter <code>composer install</code>, and click \"Save\". Now go back to the project's homepage and click \"Build Now\" and look at the console results. With any luck, you'll see the repo being cloned, and then composer installing its dependencies.</p>\n<h2>PHPUnit</h2>\n<p>So now we're ready to add our first CI action: running tests with PHPUnit. This is now very simple. Add a build step, \"Execute shell\", and enter <code>php ./bin/phpunit</code>. The first time this is run it might install PHPUnit and its dependencies via Composer, and once that's done it'll run any tests you have.</p>\n<p>You can see the output in the build's Console Output section as usual. But this is not very pretty, and it would be more useful to have a permanent record of it somewhere. The <a href=\"http://wiki.jenkins-ci.org/display/JENKINS/Clover+PHP+Plugin\">Clover PHP plugin</a> can produce reports from PHPUnit test runs. To install it, go to Manage Jenkins > Manage Plugins, click the \"Available\" tab and filter by \"clover\". [NOTE: <a href=\"https://www.youtube.com/watch?v=kuBD3p20oyE\">this guy</a> says not to use Clover PHP, it's old and abandoned. Instead use the general Clover Plugin. Maybe try this step again with only that, since we're going to need it later anyway for the Pipeline.]</p>\n<p>Now back in the project config, let's modify the call to <code>phpunit</code> to specify locations for the Clover reports:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">--coverage-clover<span class=\"token operator\">=</span><span class=\"token string\">'reports/coverage/coverage.xml'</span> --coverage-html<span class=\"token operator\">=</span><span class=\"token string\">'reports/coverage'</span></code></pre></div>\n<p>Now we just need to tell Clover to publish these reports. Add a Post-build Action, and select \"Publish Clover PHP Coverage Report\" from the dropdown. In the \"Clover XML Location\", enter \"reports/coverage/coverage.xml\", then tick the \"Publish HTML Report\" checkbox and enter \"reports/coverage\" (obviously change these if you've put different locations in the <code>phpunit</code> arguments). Now click Save, then Build, and you'll see the reports on the project's homepage.</p>\n<h2>PHP CS Fixer</h2>\n<p>The <a href=\"https://cs.symfony.com\">PHP Coding Standards Fixer</a> looks at your code and can change it to conform to any number of PHP coding standards. I run it with the <code>--dry-run</code> option so I can inspect the output and make the changes myself if I want to. We need to install it in bash:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://cs.symfony.com/download/php-cs-fixer-v2.phar -O php-cs-fixer\n<span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> a+x php-cs-fixer\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> php-cs-fixer /usr/local/bin/php-cs-fixer</code></pre></div>\n<p>Then we can add it as a build action (before composer / phpunit):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php-cs-fixer fix --dry-run --no-interaction --diff -vvv src/</code></pre></div>\n<p>Now the build will fail if it contains code which is not compliant with PHP CS Fixer's rules (by default PSR-1 and PSR-2). If you don't want the build to fail at this step (e.g. you still want tests to run even if the code is not compliant), you can add <code>|| true</code> to the end of the code.</p>\n<h2>Crap4J</h2>\n<p><a href=\"http://www.crap4j.org\">Crap4J</a> is a plugin that helps identify methods whose complexity might cause problems in the future. PHPUnit has an option to generate reports in this format. So if you want to use this, install the plugin, then add <code>--coverage-crap4j='reports/crap4j.xml'</code> to the end of the <code>phpunit</code> build step. And finally add a \"Report Crap\" post-build step.</p>\n<h2>Composer packages</h2>\n<p>Some useful metrics can be obtained from Composer packages. I prefer to install these globally on the server rather than include them as part of the <code>composer.json</code> in the project's repo. For example, PHPLoc, which gives you stats on the number of lines of code in your project, can be installed on the server with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> composer global require phploc/phploc</code></pre></div>\n<p>Then, for reasons best known to the Jenkins deities, I need to use some strange syntax to add my vendor directory to the Jenkins <code>PATH</code> environment variable. Go to <strong>Manage Jenkins > Configure System</strong>, then add an environment variable called <code>PATH+EXTRA</code>, with the value <code>/home/user_name/.composer/vendor/bin</code>. (Note: I first used <code>~</code> instead of <code>/home/user_name</code>, but that didn't seem to work.) </p>\n<h2>First pain-point: The database</h2>\n<p>If you have any tests which require accessing the database, you'll quickly run into problems. We haven't set up any databases on the server yet. We could do that, but since we'll then be heading in the direction of having to ensure our Jenkins environment matches our development environment, it makes more sense to use Docker. That way we can be sure both environments match. So let's first install Docker on our Jenkins server:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> docker.io\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> docker-compose</code></pre></div>\n<p>(Since the Ubuntu repository may not contain the latest version of Docker, if you want the latest version you'll need to follow a few more steps, outlined in <a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04\">this Digital Ocean tutorial</a>.)</p>\n<p>Then in the Jenkins UI, add a build step just before the <code>composer install</code> step:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker-compose up -d</code></pre></div>\n<p>Error! </p>\n<blockquote>\n<p>\"ERROR: Couldn't connect to Docker daemon at http+docker://localunixsocket - is it running?</p>\n<p>If it's at a non-standard location, specify the URL with the DOCKER_HOST environment variable.\"</p>\n</blockquote>\n<p>To fix this I had to add my user to the <code>docker</code> user group and restart everything:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> -aG docker username <span class=\"token comment\"># Replace with your username</span>\nsystemctl daemon-reload\nsystemctl restart docker\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> jenkins restart</code></pre></div>\n<p>Now when you trigger a build and look in the console you should see Docker pulling in the relevant images and creating the services. (Note: Depending on the size of your droplet and the memory usage of your Docker services, you may need to add swap space to your Jenkins server - in this case refer to <a href=\"https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-16-04\">this Digital Ocean tutorial</a>.)</p>\n<p>The final step is to update the subsequent steps to be called via the container:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker <span class=\"token builtin class-name\">exec</span> app_name composer <span class=\"token function\">install</span>\ndocker <span class=\"token builtin class-name\">exec</span> app_name php ./bin/phpunit --coverage-clover<span class=\"token operator\">=</span><span class=\"token string\">'reports/coverage/coverage.xml'</span> --coverage-html<span class=\"token operator\">=</span><span class=\"token string\">'reports/coverage'</span> --coverage-crap4j<span class=\"token operator\">=</span><span class=\"token string\">'reports/crap4j.xml'</span></code></pre></div>\n<h2>Second pain-point: Jenkins configuration</h2>\n<p>Rather than setting up each build step in the Jenkins UI, it would be more convienient, and more portable, to have a single configuration file that does it all. This is the <code>Jenkinsfile</code>, a text file with its own syntax, which can be checked into source control, with all the benefits that entails.</p>\n<p>To do this, create a <code>Jenkinsfile</code> in the root of your project. The syntax can be found in any number of other sources on the internet, so I'm just going to post a stripped-down version of my file here:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pipeline {\n  agent any\n  stages {\n    stage(&#39;Build&#39;) {\n      agent any\n      steps {\n        sh &#39;docker-compose up -d&#39;\n        sh &#39;docker exec app_name composer install&#39;\n      }\n    }    \n    stage(&#39;PHP CS Fixer&#39;) {\n      steps {\n        sh &#39;php-cs-fixer fix --dry-run --no-interaction --diff -vvv src/&#39;\n      }\n    }\n    stage(&#39;Test&#39;) {\n      steps {\n        sh &#39;docker exec app_name php ./bin/phpunit --coverage-clover=\\&#39;reports/coverage/coverage.xml\\&#39; --coverage-html=\\&#39;reports/coverage\\&#39;&#39;\n      }\n    }\n    stage(&#39;Coverage&#39;) {\n      steps {\n        step([$class: &#39;CloverPublisher&#39;undefined cloverReportDir: &#39;/reports/coverage&#39;undefined cloverReportFileName: &#39;coverage.xml&#39;])\n      }\n    }\n  }  \n}</code></pre></div>\n<p>As you can see, the pipeline is divided into stages, whose names are arbitrary, but which makes the output easier to read.  Once this file is in the repo, you can create a new Pipeline project and specify the repo's address. It will then automatically pull in the <code>Jenkinsfile</code> and execute its steps. (NB. Since I couldn't find a way to publish the Crap4J report in a pipeline, I've removed it from the PHPUnit output.)</p>\n<h2>Adding badges to your README file</h2>\n<p>Install the Jenkins <a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Embeddable+Build+Status+Plugin\">Embeddable Build Status plugin</a>. Next, make your project viewable by everyone: go to <strong>Manage Jenkins > Configure Global Security</strong>, then under <strong>Authorization</strong>, click \"Matrix-based security\", and for <strong>Anonymous Users</strong> check the <strong>View Status</strong> box under <strong>Jobs</strong>. For <strong>Authenticated Users</strong> click everything else. </p>\n<p>Now, back in your project, there will be a new menu item, \"Embeddable Build Status\". From there you can select the Markdown for the image you want, and paste it in your repo's <code>readme.md</code>.</p>","fields":{"title":"CI with Jenkins and Symfony","date":"08 October, 2019","url":"http://unlikenesses.com/2019-10-08-jenkins-and-symfony/"}}},"pageContext":{"slug":"/2019-10-08-jenkins-and-symfony/","prev":{"fields":{"title":"Upgrading Gatsby","date":"15 March, 2019","slug":"/2019-03-15-upgrading-gatsby/"}},"next":{"fields":{"title":"PHP iterators in the wild","date":"26 January, 2020","slug":"/2020-01-26-php-iterators-in-the-wild/"}}}}}