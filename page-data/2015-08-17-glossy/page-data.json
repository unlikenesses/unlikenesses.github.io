{"componentChunkName":"component---src-templates-post-js","path":"/2015-08-17-glossy/","webpackCompilationHash":"953b0c83299123db49b0","result":{"data":{"post":{"html":"<p>So much \"learning Laravel\" project is currently a simple app that will allow the user to keep a log of glosses / annotations to books they're reading. Basically a simple CRUD app, with the ability to add Authors, Books and Annotations to those books. This kind of thing would take me 20 minutes to do in Codeigniter, but since I'm new to Laravel it's taking a lot longer here, which is fine and to be expected.</p>\n<p>So I just wanted to keep track here of a few little bumps I encounter along the way and the way I solve them. The kind of things which are probably incredibly simple but which, coming to this framework for the first time, had me stumped until I found the solution.</p>\n<p>The first was using the <code>list</code> database method. I wanted to pass the view a list of authors to put in a dropdown. Following the <a href=\"https://laracasts.com/series/laravel-5-fundamentals/episodes/22\">Laracasts tutorials</a> this seemed the best way to pass an array of values from a single column to populate a dropdown in a view. My first problem was that my <code>authors</code> table only has <code>first_name</code> and <code>last_name</code> columns. I want both to show in the dropdown, but I can't pass them both in the <code>list</code> method.</p>\n<p>The answer was <a href=\"http://laravel.com/docs/5.1/eloquent-mutators\">mutators</a>. Following the convention in the manual (<code>get</code> + camel-cased version of name + <code>Attribute</code>), I created a function <code>getFullNameAttribute</code> which simply returned <code>$this->first_name.' '.$this->last_name</code>. This gave me a <code>full_name</code> attribute which I could pass to <code>lists</code>. My <code>create</code> function in the <code>BooksController</code> now had this line:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$authors</span> <span class=\"token operator\">=</span> \\<span class=\"token package\">App<span class=\"token punctuation\">\\</span>Author</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">lists</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'full_name'</span><span class=\"token punctuation\">,</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>However, there was another problem. This simply didn't work - the dropdown was unpopulated, or rather, it was populated with two blank lines. Doing a die and dump (<code>dd($authors)</code>) showed that an array was being passed to it, but an array of two strings consisting of just one space: <code>\" \"</code>. The solution, I found after some googling, was to call <code>all()</code> before calling the method <code>lists</code>. The final, working line is</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$authors</span> <span class=\"token operator\">=</span> \\<span class=\"token package\">App<span class=\"token punctuation\">\\</span>Author</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">lists</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'full_name'</span><span class=\"token punctuation\">,</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>It's a shame that I can't explain why this works yet. I think I need to delve deeper into Laravel before I'll be able to do that. But for now, it's working.</p>\n<p>Another great thing I discovered about Laravel was the way it deals with foreign keys and deletion. In my migration for creating the Books table, I set the <code>author_id</code> to be a foreign key. This is done using (as Jeffrey Way points out in his tutorial) a brilliantly intuitive syntax:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$table</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">foreign</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'author_id'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">references</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'authors'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The same syntax can be used to specify its behaviour when an author is deleted. Adding <code>onDelete('cascade')</code> to the chain means that if an author is deleted, all his books will be deleted too. Actually I didn't know about the MySQL <code>cascade</code> action before coming across this feature in Laravel. This is a great function which will save me loads of time in the future.</p>\n<hr>\n<p>The next problem I face is the creation of a route that allows me to view sub-tables. E.g. <code>books</code> has a foreign key, <code>author_id</code>, and I want to be able to create a route which allows me to see only the books which have an <code>author_id</code> of, say, 2. The problem is that my routes for <code>books</code> are set up using the <code>resource</code> method:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">Route<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">resource</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'books'</span><span class=\"token punctuation\">,</span><span class=\"token single-quoted-string string\">'BooksController'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>which, as the <a href=\"http://laravel.com/docs/5.1/controllers#restful-resource-controllers\">docs say</a> is used for creating multiple routes to various REST actions; but for me it's also just a quick way to set up the default CRUD routes I need. So I have routes like <code>books/create</code> or <code>books/1/edit</code> (I'm using ids rather than slugs at the moment). But what I need is a URL like <code>authors/2/books/create</code> -- in other words, the ability to add, view, and edit books for a specific author. For the moment, I have a new route:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">Route<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'authors/{id}/books'</span><span class=\"token punctuation\">,</span><span class=\"token single-quoted-string string\">'BooksController@showBooksByAuthor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Then in <code>booksController</code> I have a simple function <code>showBooksByAuthor</code>, that takes the proffered id and grabs all the books by that author, before loading the <code>books.index</code> page. This is not ideal though - I feel like I'm polluting both the <code>routes</code> file and the simplicity of the controller, but I don't yet know how to fix that.</p>\n<p>[Time passes...]</p>\n<p>Ok, a couple of hours later, I have the solution: <a href=\"http://laravel.com/docs/5.1/controllers#restful-nested-resources\">nested resources</a>. I replace </p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">Route<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">resource</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'books'</span><span class=\"token punctuation\">,</span><span class=\"token single-quoted-string string\">'BooksController'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>with</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">Route<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">resource</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'authors.books'</span><span class=\"token punctuation\">,</span><span class=\"token single-quoted-string string\">'BooksController'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>and hey presto, the URL system is set up precisely as I envisaged it. It's almost as if Laravel read my mind. Some changes have had to be made. For instance, I realised that when opening the form for creating new books, one has to pass the <code>author_id</code> in:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">Form<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'route'</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'authors.books.store'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$author</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But for me to do that I had to grab the <code>author</code> -- where could I do that? It took me some searching to figure out that with nested routes the URL variables are passed as arguments to the controller methods. So in my <code>create</code> method in the <code>booksController</code> I could just grab the author as an argument and send it to the create view. </p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>Author <span class=\"token variable\">$author</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">view</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'books.create'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'author'</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token variable\">$author</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I can then add the same argument to the <code>store</code> method:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">store</span><span class=\"token punctuation\">(</span>Requests\\<span class=\"token package\">BookRequest</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> Author <span class=\"token variable\">$author</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The next problem is that even if I pass the <code>$author</code> to the <code>store</code> function, I still need to extract the <code>author_id</code> and add it to the <code>$request</code>. I solve this problem by adding the <code>author_id</code> to the <code>$request</code> array: <code>$request['author_id'] = $author->id;</code>. It doesn't seem elegant but it works for now.</p>","fields":{"title":"glossy","date":"17 August, 2015","url":"http://unlikenesses.com/2015-08-17-glossy/"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2015-08-17-glossy/","prev":{"fields":{"title":"commentment","date":"29 July, 2015","slug":"/2015-07-29-commentment/"}},"next":{"fields":{"title":"literally literals","date":"06 September, 2015","slug":"/2015-09-06-literally-literals/"}}}}}