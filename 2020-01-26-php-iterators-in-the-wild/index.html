<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.c80581122dc77a5cdbb4.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}small{font-size:80%}h1,p{margin:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}h1{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-gray-300{--bg-opacity:1;background-color:#e2e8f0;background-color:rgba(226,232,240,var(--bg-opacity))}.hover\:bg-gray-400:hover{--bg-opacity:1;background-color:#cbd5e0;background-color:rgba(203,213,224,var(--bg-opacity))}.rounded{border-radius:.25rem}.flex{display:flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-between{justify-content:space-between}.font-bold{font-weight:700}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-4xl{font-size:2.25rem}.text-5xl{font-size:3rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mr-3{margin-right:.75rem}.p-6{padding:1.5rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pt-2{padding-top:.5rem}.pb-3{padding-bottom:.75rem}.pl-3{padding-left:.75rem}.pb-5{padding-bottom:1.25rem}.pt-6{padding-top:1.5rem}.pb-6{padding-bottom:1.5rem}.pb-8{padding-bottom:2rem}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06)}.hover\:shadow-md:hover{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.text-left{text-align:left}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-gray-700{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}.text-pink-600{--text-opacity:1;color:#d53f8c;color:rgba(213,63,140,var(--text-opacity))}.hover\:text-gray-700:hover{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}.hover\:text-pink-600:hover{--text-opacity:1;color:#d53f8c;color:rgba(213,63,140,var(--text-opacity))}.uppercase{text-transform:uppercase}.capitalize{text-transform:capitalize}.no-underline{text-decoration:none}.hover\:underline:hover{text-decoration:underline}.w-1\/2{width:50%}.w-2\/3{width:66.666667%}.w-full{width:100%}.nunito{font-family:Nunito,sans-serif}p{line-height:2}h2,p{margin-bottom:1.5rem}h2{font-size:1.5rem;margin-top:.5rem}h2,h3{font-weight:700}h3{font-size:1.25rem;margin-top:1rem;margin-bottom:1.25rem}h4{font-size:1.125rem;font-weight:700}code{--text-opacity:1;color:#ed64a6;color:rgba(237,100,166,var(--text-opacity));--bg-opacity:1;background-color:#fff5f7;background-color:rgba(255,245,247,var(--bg-opacity));border-radius:.375rem;padding:.25rem .5rem}pre code{padding-left:0;padding-right:0}a{color:#ed64a6;color:rgba(237,100,166,var(--text-opacity));text-decoration:underline}a,blockquote{--text-opacity:1}blockquote{--border-opacity:1;border-color:#ed64a6;border-color:rgba(237,100,166,var(--border-opacity));border-left-width:4px;padding-left:1rem;margin-bottom:.75rem;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}ul{list-style-type:disc;margin-bottom:.5rem}ol,ul{list-style-position:inside}ol{list-style-type:decimal}</style><meta name="generator" content="Gatsby 2.18.17"/><title data-react-helmet="true">Unlikenesses</title><meta data-react-helmet="true" name="description" content="A PHP Developer"/><link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet"/><link as="script" rel="preload" href="/styles-9a353c6f1161ef8c88fb.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-31d5885bc3a738a8d113.js"/><link as="script" rel="preload" href="/commons-a98b242466aa29e9f3f5.js"/><link as="script" rel="preload" href="/app-3d34126c26312025b100.js"/><link as="script" rel="preload" href="/webpack-runtime-442c371bc34315c411cc.js"/><link as="fetch" rel="preload" href="/page-data\2020-01-26-php-iterators-in-the-wild\page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="nunito"><div class="container w-2/3 mx-auto flex flex-wrap py-6"><header class="pl-3 pb-6"><a class="font-bold text-gray-700 uppercase hover:text-gray-700 text-5xl no-underline" href="/">Unlikenesses <span class="text-xl">A PHP Developer</span></a><nav><a class="no-underline mr-3 text-gray-600 hover:text-pink-600" href="https://twitter.com/unlikenesses" target="_blank" rel="noopener noreferrer">Twitter</a><a class="no-underline mr-3 text-gray-600 hover:text-pink-600" href="https://github.com/unlikenesses" target="_blank" rel="noopener noreferrer">GitHub</a><a class="no-underline text-gray-600 hover:text-pink-600" href="http://codepen.io/unlikenesses/" target="_blank" rel="noopener noreferrer">CodePen</a></nav></header><section class="w-full flex flex-col items-center px-3"><article class="w-full flex flex-col my-4"><div class="bg-white flex flex-col justify-start py-6"><h1 class="text-4xl font-bold text-gray-700 capitalize">PHP iterators in the wild</h1><span class="text-sm pb-8 text-gray-600">26 January, 2020</span><div class="text-gray-700 text-lg"><p>Although they were introduced way back in PHP 5, iterators are one of the language's less commonly used features. Almost all articles about PHP iterators seem to resort to one of two fairly contrived examples: reading a file line-by-line, or creating a bespoke <code>range</code> function. In this post I want to take a look at some examples of their use in open source applications, with the hope that this approach will demonstrate how they can solve real-world problems.</p>
<p>In lieu of an introduction, I will point you to the most helpful explanation of iterators I've found, Anthony Ferrara's video <a href="https://www.youtube.com/watch?v=tW6GcZjBc3E">"Iterators"</a>. He shows how a basic <code>for</code> loop in PHP is analogous to the methods implementable in PHP's <a href="https://www.php.net/manual/en/class.iterator.php">Iterator interface</a>, such that </p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre></div>
<p>corresponds to </p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$it</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$it</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$it</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$it</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>(where <code>$it->key()</code> in the second example maps to <code>$i</code> in the first example). (These operations, <code>rewind</code>, <code>valid</code>, <code>next</code>, <code>key</code> and (not mentioned above) <code>current</code>, correspond to the classes defined in the Iterator pattern as described in Gang of Four.)</p>
<h2>Example 1: Flysystem</h2>
<p>As I said, file operations are a favourite example when introducing iterators. One concrete implementation would be the PHP League's <a href="https://github.com/thephpleague/flysystem">Flysystem</a> package. Its <a href="https://flysystem.thephpleague.com/v1/docs/usage/filesystem-api/#list-contents"><code>listContents</code> method</a> takes a path string and a boolean to specify whether or not the contents should be listed recursively. If we take a look at <a href="https://github.com/thephpleague/flysystem/blob/d03f7e1e0f2fa47f52d445a60ec8ed93d433ddc1/src/Adapter/Local.php#L269">the code for this method on GitHub</a>, we'll find that it instantiates an iterator (either a <code>DirectoryIterator</code> or a <code>RecursiveDirectoryIterator</code> depending on the boolean), which then makes it very easy to traverse the contents of the directory with a simple <code>foreach</code> loop. Far simpler than messing about with <code>openddir</code>, <code>readdir</code>, etc. (Note the package also makes use of <code>FilesystemIterator</code>, which allows you to skip <code>.</code> and <code>..</code> when traversing a directory tree.)</p>
<h2>Example 2: PHP Unit</h2>
<p>Another useful iterator is the <a href="https://www.php.net/manual/en/class.filteriterator.php"><code>FilterIterator</code></a>. By creating a class which extends this iterator, you can easily filter the result of iterators by wrapping them with your new filter iterator. An example of this in the wild is in PHP Unit. You've probably run <code>phpunit --filter</code>, <code>phpunit --group</code>, or <code>phpunit --exclude-group</code>, many times. If we look in PHP Unit's <a href="https://github.com/sebastianbergmann/phpunit/blob/master/src/TextUI/TestRunner.php#L1258">GitHub repo</a> we find a method <code>processSuiteFilters</code>. This method makes use of a few classes in the <a href="https://github.com/sebastianbergmann/phpunit/tree/1d937a963f5755ad8298c400447f812c65ddc687/src/Runner/Filter"><code>PHPUnit/Runner/Filter</code> namespace</a>, specifically a factory, then a number of Iterators which extend <code>FilterIterator</code> (or rather <code>RecursiveFilterIterator</code>, which itself extends <code>FilterIterator</code>). All filter iterators require an <code>accept</code> method. For example, the <code>accept</code> method of the <code>IncludeGroupFilterIterator</code> checks whether the current test (in the traversal) is in the array of groups permissible by the user's filter.</p>
<h2>Example 3: Symfony Finder</h2>
<p>In <a href="http://fabien.potencier.org/php-iterators-and-streams-are-awesome.html">a blog post</a> from 2010, Symfony creator Fabien Potencier said that iterators were "largely underused", and described using them when rewriting the <a href="https://github.com/symfony/symfony/blob/2.0/src/Symfony/Component/Finder/Finder.php">Finder component</a> for Symfony 2. </p>
<p>The Finder component combines the approaches outlined in the previous two examples: the <code>DirectoryIterator</code> and the <code>FilterIterator</code>. Here Potencier implements the <a href="https://www.php.net/manual/en/class.iteratoraggregate.php">IteratorAggregate interface</a>, which requires just one method, <code>getIterator</code>, which returns an external iterator. In the case of <code>Finder</code>, it returns PHP's <a href="https://www.php.net/manual/en/class.appenditerator">AppendIterator</a>. So, to adapt the example from <a href="https://symfony.com/doc/2.0/components/finder.html">the manual</a>:</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token variable">$finder</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Finder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$finder</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">in</span><span class="token punctuation">(</span><span class="token constant">__DIR__</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">in</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/home'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$finder</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do stuff</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here we want the finder instance to focus only on files (<code>files()</code>) and to look in the current and <code>/home</code> directories. Each repeated <code>in</code> call just adds its argument to the class's <code>dirs</code> property. Finally, when the iterator is triggered with the <code>foreach</code> statement, then for every directory in the <code>dirs</code> array, it does two things. First, it calls the <code>searchInDirectory</code> method, which basically configures the iterator. Like Flysystem, it uses the <a href="https://www.php.net/manual/en/class.recursivedirectoryiterator.php">RecursiveDirectoryIterator</a> and adds some bespoke Symfony filters depending on Finder's configuration (these filters extend PHP's <a href="https://www.php.net/manual/en/class.filteriterator.php">FilterIterator</a>). Second, having obtained this iterator, it adds it to the <code>AppendIterator</code> it instantiated earlier. Finally it appends any more iterators that have been explicitly provided by the user, and returns the <code>AppendIterator</code>. So here we have an example of PHP's various iterator classes providing a clean way to compose an extensible, flexible API for traversing a file system.</p>
<h2>Example 4: CSV</h2>
<p>Another use of iterators is as a memory-saving technique. When you are dealing with data sets of very large, or of unknown, size, processing the data iteratively means you do not suffer the performance drawbacks of holding the entire data set in memory. Basically, it can turn an O(n) process to an O(1) process.</p>
<p>As an example, let's look at another PHP League package, <a href="https://csv.thephpleague.com">CSV</a>, which makes heavy use of iterators. What happens when you run this code? </p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token variable">$csv</span> <span class="token operator">=</span> Reader<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">createFromPath</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/path/to/file.csv'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$records</span> <span class="token operator">=</span> <span class="token variable">$csv</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>First the static <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/AbstractCsv.php#L172"><code>createFromPath</code> method</a> returns an instance of the <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/Stream.php#L49"><code>Stream</code> object</a>, which in turn implements PHP's <a href="https://www.php.net/manual/en/class.seekableiterator.php"><code>SeekableIterator</code></a>. This is a simple extension to the common-or-garden iterator, allowing clients to specify the position of the cursor. This instance of the Stream object is set to the <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/AbstractCsv.php#L105"><code>document</code> property</a> of the <code>AbstractCsv</code> class which <code>Reader</code> <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/Reader.php#L51">extends</a>. </p>
<p>Next, <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/Reader.php#L269"><code>getRecords</code></a> gives the client this iterator after applying some cleaning to it. <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/Reader.php#L282">This line</a> does two things: first, it uses PHP's <a href="https://www.php.net/manual/en/class.callbackfilteriterator.php"><code>CallbackFilterIterator</code></a> to normalize the data (remove any corrupt or empty rows), before using the package's own <a href="https://github.com/thephpleague/csv/blob/42c8916bd02d05169ea31a9479cc789a082cd93f/src/MapIterator.php"><code>MapIterator</code></a> to remove any <a href="https://en.wikipedia.org/wiki/Byte_order_mark">BOMs</a>. Next the <code>getRecords</code> method uses another <code>CallbackFilterIterator</code> to skip headers if required. Finally, it returns the return value of <code>combineHeader</code>, a method which takes the iterator produced so far in <code>getRecords</code> and if necessary adds a header to the records using another <code>MapIterator</code>. All of this means that at the end you have an iterator you can use to <code>foreach</code> over the records in a CSV file.</p></div></div></article><div class="w-full flex pt-6"><a class="w-1/2 bg-white shadow hover:shadow-md text-left p-6 no-underline" href="/2019-10-08-jenkins-and-symfony/"><p class="text-lg text-gray-700 font-bold flex items-center">Previous<!-- -->:</p><p class="pt-2 capitalize">CI with Jenkins and Symfony<!-- --> <small>08 October, 2019</small></p></a><a class="w-1/2 bg-white shadow hover:shadow-md text-left p-6 no-underline" href="/2020-03-14-php-generators-in-the-wild/"><p class="text-lg text-gray-700 font-bold flex items-center">Next<!-- -->:</p><p class="pt-2 capitalize">PHP generators in the wild<!-- --> <small>14 March, 2020</small></p></a></div></section></div><footer class="container w-2/3 mx-auto flex flex-wrap py-4 px-5 justify-between text-gray-600"><p>Unlikenesses</p><p>Built with <a href="https://www.gatsbyjs.org" target="_blank">GatsbyJS</a> and <a href="https://tailwindcss.com" target="_blank">Tailwind CSS</a></p></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020-01-26-php-iterators-in-the-wild/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-3d34126c26312025b100.js"],"component---src-templates-index-js":["/component---src-templates-index-js-ef7da5a2960572cc5911.js"],"component---src-templates-post-js":["/component---src-templates-post-js-31d5885bc3a738a8d113.js"],"component---src-pages-404-js":["/component---src-pages-404-js-224a4a61ab9775ba900d.js"]};/*]]>*/</script><script src="/webpack-runtime-442c371bc34315c411cc.js" async=""></script><script src="/app-3d34126c26312025b100.js" async=""></script><script src="/commons-a98b242466aa29e9f3f5.js" async=""></script><script src="/component---src-templates-post-js-31d5885bc3a738a8d113.js" async=""></script><script src="/styles-9a353c6f1161ef8c88fb.js" async=""></script></body></html>